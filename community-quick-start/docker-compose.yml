services:
  mongod:
    image: mongodb/mongodb-community-server:latest
    container_name: mongod-community
    command: >-
      mongod
      --config /etc/mongod.conf
      --replSetMember=mongod.search-community:27017
    ports:
      - 27017:27017
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - mongod_data:/data/db
      - ./mongod.conf:/etc/mongod.conf:ro
      - ./sampledata.archive:/sampledata.archive
      - ./init-mongo.sh:/docker-entrypoint-initdb.d/init-mongo.sh:ro
    networks:
      search-community:
        aliases:
          - mongod.search-community

  # MongoDB Search (mongot) service
  # Supports two deployment modes:
  # 1. Default mode: Uses pre-built image from Docker Hub
  #    Usage: docker compose up -d
  # 2. Local development mode: Uses locally-built image
  #    Usage: docker compose --profile local up -d
  mongot:
    # Default: use the latest pre-built image from Docker Hub
    image: ${MONGOT_IMAGE:-mongodb/mongodb-community-search:latest}
    container_name: mongot-community
    profiles:
      - ""  # Active in default profile (no profile specified)
    networks:
      search-community:
        aliases:
          - mongot.search-community
    volumes:
      - mongot_data:/data/mongot
      - ./mongot.conf:/mongot-community/config.default.yml
      - ./pwfile:/mongot-community/pwfile:ro
    depends_on:
      - mongod
    ports:
      - 27028:27028  # Query server port from config
      - 9946:9946    # Metrics port from config

  # Local development mode: uses locally-built image
  # Activate with: docker compose --profile local up -d
  mongot-local:
    image: mongot-community-local:latest
    container_name: mongot-community
    profiles:
      - local
    networks:
      search-community:
        aliases:
          - mongot.search-community
    volumes:
      - mongot_data:/data/mongot
      - ./mongot.conf:/mongot-community/config.default.yml
      - ./pwfile:/mongot-community/pwfile:ro
    depends_on:
      - mongod
    ports:
      - 27028:27028  # Query server port from config
      - 9946:9946    # Metrics port from config
volumes:
  mongod_data:
  mongot_data:
networks:
  search-community:
    name: search-community
    external: true  # Use an external network if it exists. Comment this line if you want to create a new network.